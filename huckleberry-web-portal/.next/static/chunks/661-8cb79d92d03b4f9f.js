"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[661],{8817:(e,t,r)=>{r.d(t,{G:()=>d});var a=r(5155),i=r(2115),s=r(1963);async function n(e){try{return await (0,s.A)(e,{maxSizeMB:1,maxWidthOrHeight:1920,useWebWorker:!0,fileType:"image/webp"})}catch(t){return console.error("Error compressing image:",t),e}}async function o(e){try{return await (0,s.A)(e,{maxSizeMB:.1,maxWidthOrHeight:300,useWebWorker:!0,fileType:"image/webp"})}catch(t){return console.error("Error generating thumbnail:",t),n(e)}}async function l(e){let t=e.size/1048576;if(t>10)throw Error("File size (".concat(t.toFixed(2),"MB) exceeds maximum allowed size of ").concat(10,"MB"));let r=await n(e),a=await o(e);return{compressed:r,thumbnail:a,originalSize:e.size,compressedSize:r.size,thumbnailSize:a.size}}function d(e){let{mentorshipId:t,sessionNoteId:r,onUpload:s,currentImageCount:n,imageLimit:o=75,isAdmin:d=!1}=e,[c,g]=(0,i.useState)([]),[m,h]=(0,i.useState)(!1),[u,b]=(0,i.useState)(!1),[x,p]=(0,i.useState)(null!=n?n:0),[f,y]=(0,i.useState)(void 0===n);(0,i.useEffect)(()=>{if(void 0!==n)p(n),y(!1);else{let e=new URLSearchParams({mentorshipId:t});r&&e.append("sessionNoteId",r),fetch("/api/images/count?".concat(e.toString()),{cache:"no-store"}).then(e=>e.json()).then(e=>{p(e.count||0),y(!1)}).catch(e=>{console.error("Failed to fetch image count:",e),y(!1)})}},[t,r,n]);let w=(0,i.useCallback)(()=>{let e=new URLSearchParams({mentorshipId:t});r&&e.append("sessionNoteId",r),fetch("/api/images/count?".concat(e.toString()),{cache:"no-store"}).then(e=>e.json()).then(e=>{p(e.count||0)}).catch(e=>{console.error("Failed to refresh image count:",e)})},[t,r]);(0,i.useEffect)(()=>{let e=()=>{"visible"===document.visibilityState&&w()};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[w]);let k=d||x<o,v=d?1/0:Math.max(0,o-x);async function j(e){let t=[];for(let r of e){let e=URL.createObjectURL(r),a={original:r,compressed:r,thumbnail:r,preview:e,originalSize:r.size,compressedSize:r.size,thumbnailSize:r.size,processing:!0};t.push(a),g(e=>[...e,a]);try{let e=await l(r);g(t=>t.map(t=>t.original===r?{...t,compressed:e.compressed,thumbnail:e.thumbnail,originalSize:e.originalSize,compressedSize:e.compressedSize,thumbnailSize:e.thumbnailSize,processing:!1}:t))}catch(e){console.error("Error processing image:",e),g(t=>t.map(t=>t.original===r?{...t,processing:!1,error:e instanceof Error?e.message:"Failed to process image"}:t))}}}async function N(){if(0!==c.length){if(c.some(e=>e.processing))return void alert("Please wait for images to finish processing before uploading.");if(c.some(e=>e.error))return void alert("Some images failed to process. Please remove them and try again.");if(!d&&x+c.length>o)return void alert("Upload would exceed the limit of ".concat(o," images (shared across all sessions). Please remove some files."));b(!0);try{let e=new FormData;e.append("mentorshipId",t),r&&e.append("sessionNoteId",r),c.forEach(t=>{e.append("compressed",t.compressed),e.append("thumbnails",t.thumbnail),e.append("originalSizes",t.originalSize.toString()),e.append("compressedSizes",t.compressedSize.toString()),e.append("thumbnailSizes",t.thumbnailSize.toString())});let a=await fetch("/api/images/upload",{method:"POST",body:e});if(a.ok)await a.json(),c.forEach(e=>URL.revokeObjectURL(e.preview)),g([]),w(),s&&s();else{let e=await a.json().catch(()=>({}));alert(e.error||"Failed to upload images")}}catch(e){console.error("Upload error:",e),alert("Failed to upload images. Please try again.")}finally{b(!1)}}}return(0,a.jsxs)("div",{className:"border border-gray-200 dark:border-neutral-900 rounded-md p-4 bg-white dark:bg-neutral-950",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsx)("div",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Upload Images"}),!d&&(0,a.jsx)("div",{className:"flex items-center gap-3",children:f?(0,a.jsx)("div",{className:"px-3 py-1.5 rounded-md font-semibold text-sm bg-gray-100 dark:bg-gray-900 text-gray-600 dark:text-gray-400",children:"Loading..."}):(0,a.jsxs)("div",{className:"px-3 py-1.5 rounded-md font-semibold text-sm ".concat(v>5?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400":v>0?"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400":"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400"),children:[x,"/",o," images (shared across all sessions)",v>0&&" • ".concat(v," remaining")]})})]}),(0,a.jsxs)("div",{className:"rounded-lg border-2 border-dashed p-12 text-center transition-all ".concat(k?m?"border-indigo-500 bg-indigo-50 dark:bg-indigo-950/30 dark:border-indigo-400 scale-[1.02] cursor-pointer":"border-gray-300 dark:border-neutral-700 hover:border-indigo-400 dark:hover:border-indigo-500 hover:bg-gray-50 dark:hover:bg-neutral-900/50 cursor-pointer":"border-gray-200 dark:border-neutral-800 opacity-50 cursor-not-allowed"),onDrop:function(e){if(e.preventDefault(),h(!1),!k)return void alert("Image limit reached (".concat(o," images shared across all sessions). Please delete some images before uploading more."));let t=Array.from(e.dataTransfer.files||[]).filter(e=>e.type.startsWith("image/"));t.length>0&&(j(d?t:t.slice(0,v)),!d&&t.length>v&&alert("Only ".concat(v," more image(s) can be uploaded (").concat(o," total limit shared across all sessions). ").concat(t.length-v," file(s) were not added.")))},onDragOver:function(e){e.preventDefault(),k&&h(!0)},onDragLeave:function(){h(!1)},onClick:()=>{var e;return k&&(null==(e=document.getElementById("file-input-".concat(t)))?void 0:e.click())},children:[(0,a.jsx)("div",{className:"space-y-3",children:k?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("p",{className:"text-base font-medium text-gray-700 dark:text-neutral-300",children:"Drag and drop images here"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-neutral-500",children:"or click to browse files"}),(0,a.jsx)("p",{className:"text-xs text-gray-400 dark:text-neutral-600 mt-2",children:"Images will be compressed automatically"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("p",{className:"text-base font-medium text-gray-500 dark:text-neutral-400",children:["Image limit reached (",o," images shared across all sessions)"]}),(0,a.jsx)("p",{className:"text-sm text-gray-400 dark:text-neutral-600",children:"Delete some images to upload more"})]})}),(0,a.jsx)("input",{id:"file-input-".concat(t),type:"file",multiple:!0,accept:"image/*",onChange:function(e){if(e.target.files&&k){let t=Array.from(e.target.files).filter(e=>e.type.startsWith("image/"));t.length>0&&(j(d?t:t.slice(0,v)),!d&&t.length>v&&alert("Only ".concat(v," more image(s) can be uploaded (").concat(o," total limit shared across all sessions). ").concat(t.length-v," file(s) were not added.")))}e.target.value=""},disabled:!k,className:"hidden"})]}),c.length>0&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"grid grid-cols-3 gap-2 mt-3",children:c.map((e,t)=>(0,a.jsxs)("div",{className:"relative",children:[e.processing?(0,a.jsx)("div",{className:"w-full h-24 rounded border border-gray-200 dark:border-neutral-800 bg-gray-100 dark:bg-neutral-900 flex items-center justify-center",children:(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-neutral-500",children:"Processing..."})}):e.error?(0,a.jsx)("div",{className:"w-full h-24 rounded border border-red-300 dark:border-red-800 bg-red-50 dark:bg-red-950/30 flex items-center justify-center",children:(0,a.jsx)("div",{className:"text-xs text-red-600 dark:text-red-400 text-center px-1",children:"Error"})}):(0,a.jsx)("img",{src:e.preview,alt:"Preview ".concat(t+1),className:"w-full h-24 object-cover rounded border border-gray-200 dark:border-neutral-800"}),(0,a.jsx)("button",{onClick:()=>{g(e=>{let r=e[t];return r&&URL.revokeObjectURL(r.preview),e.filter((e,r)=>r!==t)})},className:"absolute top-1 right-1 w-5 h-5 rounded-full bg-red-500 hover:bg-red-600 text-white text-xs flex items-center justify-center",title:"Remove",children:"\xd7"}),e.processing&&(0,a.jsx)("div",{className:"absolute bottom-1 left-1 right-1 bg-black/50 text-white text-xs px-1 py-0.5 rounded",children:"Compressing..."})]},t))}),(0,a.jsxs)("div",{className:"mt-3 flex items-center gap-3",children:[(0,a.jsx)("button",{onClick:N,disabled:u||c.some(e=>e.processing||e.error),className:"inline-flex items-center px-4 py-2 rounded-md bg-indigo-600 dark:bg-indigo-500 text-white hover:bg-indigo-700 dark:hover:bg-indigo-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:u?"Uploading...":"Upload ".concat(c.length," file(s)")}),c.length>0&&(0,a.jsx)("button",{onClick:()=>{c.forEach(e=>URL.revokeObjectURL(e.preview)),g([])},className:"text-sm text-gray-600 dark:text-neutral-400 hover:text-gray-900 dark:hover:text-neutral-200",children:"Clear all"})]})]})]})}},9261:(e,t,r)=>{r.d(t,{i:()=>h});var a=r(5155),i=r(2115),s=r(4820),n=r(2678),o=r(3630),l=r(3489),d=r(2251),c=r(6615),g=r(1190),m=r(3263);function h(e){let{images:t,onDelete:r,showDelete:h=!0,mentorshipId:u,sessionNoteId:b}=e,[x,p]=(0,i.useState)(null),[f,y]=(0,i.useState)(null),[w,k]=(0,i.useState)(!1),[v,j]=(0,i.useState)(new Set),[N,z]=(0,i.useState)(!1),[S,E]=(0,i.useState)(!1);async function C(e,a){if(null==a||a.stopPropagation(),r&&confirm("Are you sure you want to delete this image?")){p(e);try{let a=await fetch("/api/images/".concat(e),{method:"DELETE"});if(a.ok){var i;r(e),null!==f&&(null==(i=t[f])?void 0:i.id)===e&&y(null),j(t=>{let r=new Set(t);return r.delete(e),r})}else{let e=await a.json().catch(()=>({}));alert(e.error||"Failed to delete image")}}catch(e){console.error("Failed to delete image:",e),alert("Failed to delete image")}finally{p(null)}}}async function L(){var e;if(0===v.size||!confirm("Are you sure you want to delete ".concat(v.size," image(s)?")))return;z(!0);let a=Array.from(v),i=await Promise.allSettled(a.map(e=>fetch("/api/images/".concat(e),{method:"DELETE"}))),s=[],n=[];i.forEach((e,t)=>{"fulfilled"===e.status&&e.value.ok?s.push(a[t]):n.push(a[t])}),r&&s.forEach(e=>r(e)),null!==f&&s.includes((null==(e=t[f])?void 0:e.id)||"")&&y(null),j(new Set),k(!1),n.length>0?alert("Failed to delete ".concat(n.length," image(s). ").concat(s.length," deleted successfully.")):alert("Successfully deleted ".concat(s.length," image(s).")),z(!1)}async function A(){if(u&&!S){E(!0);try{let e=new URLSearchParams({mentorshipId:u});b&&e.append("sessionNoteId",b);let t=await fetch("/api/images/download?".concat(e.toString()));if(!t.ok){let e=await t.json().catch(()=>({}));alert(e.error||"Failed to download images");return}let r=t.headers.get("Content-Disposition"),a=b?"session_images_".concat(b,".zip"):"mentorship_images_".concat(u,".zip");if(r){let e=r.match(/filename="?(.+?)"?$/);e&&(a=e[1])}let i=await t.blob(),s=window.URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=a,document.body.appendChild(n),n.click(),window.URL.revokeObjectURL(s),document.body.removeChild(n)}catch(e){console.error("Download error:",e),alert("Failed to download images. Please try again.")}finally{E(!1)}}}function F(){y(null)}function U(e){null!==f&&("prev"===e?y(f>0?f-1:t.length-1):"next"===e&&y(f<t.length-1?f+1:0))}if((0,i.useEffect)(()=>{if(null!==f)return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e);function e(e){"Escape"===e.key?y(null):"ArrowLeft"===e.key&&null!==f?y(f>0?f-1:t.length-1):"ArrowRight"===e.key&&null!==f&&y(f<t.length-1?f+1:0)}},[f,t.length]),0===t.length)return(0,a.jsx)("div",{className:"p-4 rounded-md border border-gray-200 dark:border-neutral-900 bg-white dark:bg-neutral-950",children:(0,a.jsx)("p",{className:"text-sm text-gray-600 dark:text-neutral-400",children:"No images uploaded yet."})});let P=null!==f?t[f]:null,D=t.length>0&&v.size===t.length;return v.size>0&&(v.size,t.length),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"mb-4 flex items-center justify-between",children:[(0,a.jsx)("div",{className:"flex items-center gap-3",children:h&&r&&(0,a.jsx)(a.Fragment,{children:w?(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("button",{onClick:()=>{k(!1),j(new Set)},className:"px-4 py-2 rounded-md border border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 text-gray-700 dark:text-neutral-300 hover:bg-gray-50 dark:hover:bg-neutral-800 transition-colors",children:"Cancel"}),(0,a.jsx)("button",{onClick:function(){v.size===t.length?j(new Set):j(new Set(t.map(e=>e.id)))},className:"inline-flex items-center gap-2 px-4 py-2 rounded-md border border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 text-gray-700 dark:text-neutral-300 hover:bg-gray-50 dark:hover:bg-neutral-800 transition-colors",children:D?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.A,{size:18}),(0,a.jsx)("span",{children:"Deselect All"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.A,{size:18}),(0,a.jsx)("span",{children:"Select All"})]})}),v.size>0&&(0,a.jsxs)("button",{onClick:L,disabled:N,className:"inline-flex items-center gap-2 px-4 py-2 rounded-md bg-red-600 dark:bg-red-500 text-white hover:bg-red-700 dark:hover:bg-red-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[(0,a.jsx)(o.A,{size:18}),(0,a.jsxs)("span",{children:["Delete ",v.size," Selected"]})]}),(0,a.jsxs)("span",{className:"text-sm text-gray-600 dark:text-neutral-400",children:[v.size," of ",t.length," selected"]})]}):(0,a.jsxs)("button",{onClick:()=>k(!0),className:"inline-flex items-center gap-2 px-4 py-2 rounded-md border border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 text-gray-700 dark:text-neutral-300 hover:bg-gray-50 dark:hover:bg-neutral-800 transition-colors",children:[(0,a.jsx)(s.A,{size:18}),(0,a.jsx)("span",{children:"Select Images"})]})})}),u&&t.length>0&&(0,a.jsxs)("button",{onClick:A,disabled:S,className:"inline-flex items-center gap-2 px-4 py-2 rounded-md bg-indigo-600 dark:bg-indigo-500 text-white hover:bg-indigo-700 dark:hover:bg-indigo-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[(0,a.jsx)(l.A,{size:18}),(0,a.jsx)("span",{children:S?"Downloading...":"Download Images"})]})]}),(0,a.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3",children:t.map((e,t)=>{let i=v.has(e.id);return(0,a.jsxs)("figure",{className:"relative rounded-md overflow-hidden border-2 bg-white dark:bg-neutral-950 group transition-all ".concat(w&&i?"border-indigo-500 dark:border-indigo-400 ring-2 ring-indigo-500 dark:ring-indigo-400 ring-offset-2":"border-gray-200 dark:border-neutral-900 cursor-pointer"),onClick:()=>{if(w){var r;r=e.id,j(e=>{let t=new Set(e);return t.has(r)?t.delete(r):t.add(r),t})}else y(t)},children:[w&&(0,a.jsx)("div",{className:"absolute top-2 left-2 z-20",children:(0,a.jsx)("div",{className:"w-6 h-6 rounded border-2 flex items-center justify-center transition-colors ".concat(i?"bg-indigo-600 dark:bg-indigo-500 border-indigo-600 dark:border-indigo-500":"bg-white/90 dark:bg-neutral-900/90 border-gray-300 dark:border-neutral-700"),children:i&&(0,a.jsx)(d.A,{size:16,className:"text-white"})})}),(0,a.jsx)("img",{src:e.thumbnail_url||e.image_url,alt:e.caption||"image",className:"w-full h-40 object-cover transition-opacity ".concat(w&&i?"opacity-75":""),loading:"lazy"}),h&&r&&!w&&(0,a.jsx)("button",{onClick:t=>C(e.id,t),disabled:x===e.id,className:"absolute top-2 right-2 p-1.5 rounded-md bg-red-600 dark:bg-red-500 text-white opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-700 dark:hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed z-10",title:"Delete image",children:(0,a.jsx)(o.A,{size:16})}),e.caption&&(0,a.jsx)("figcaption",{className:"text-xs p-2 text-gray-600 dark:text-neutral-400",children:e.caption})]},e.id)})}),null!==f&&P&&(0,a.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/90 dark:bg-black/95 p-4",onClick:F,children:[(0,a.jsx)("button",{onClick:F,className:"absolute top-4 right-4 p-2 rounded-md bg-white/10 dark:bg-white/10 hover:bg-white/20 dark:hover:bg-white/20 text-white transition-colors z-10",title:"Close (ESC)",children:(0,a.jsx)(c.A,{size:24})}),(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),U("prev")},className:"absolute left-4 top-1/2 -translate-y-1/2 p-2 rounded-md bg-white/10 dark:bg-white/10 hover:bg-white/20 dark:hover:bg-white/20 text-white transition-colors z-10",title:"Previous (←)",children:(0,a.jsx)(g.A,{size:32})}),(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),U("next")},className:"absolute right-4 top-1/2 -translate-y-1/2 p-2 rounded-md bg-white/10 dark:bg-white/10 hover:bg-white/20 dark:hover:bg-white/20 text-white transition-colors z-10",title:"Next (→)",children:(0,a.jsx)(m.A,{size:32})}),(0,a.jsxs)("div",{className:"relative max-w-7xl max-h-full flex flex-col items-center",onClick:e=>e.stopPropagation(),children:[(0,a.jsx)("img",{src:P.image_url,alt:P.caption||"image",className:"max-w-full max-h-[90vh] object-contain"}),P.caption&&(0,a.jsx)("p",{className:"mt-4 text-white text-center max-w-2xl px-4",children:P.caption}),(0,a.jsxs)("p",{className:"mt-2 text-white/70 text-sm",children:[f+1," / ",t.length]})]})]})]})}}}]);